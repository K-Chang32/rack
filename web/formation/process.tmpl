{{ define "formation" }}
  {{ if .Process.Balancer }}
    "Convox{{ upper .Process.App }}{{ upper .Process.Name }}BalancerSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "{{ .Process.Name}} Balancer",
        "SecurityGroupIngress": [
          { "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "CidrIp": "0.0.0.0/0" }
        ],
        "VpcId": { "Ref": "Convox{{ upper .Process.App }}BaseVpc" }
      }
    },
    "Convox{{ upper .Process.App }}{{ upper .Process.Name }}Balancer": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "Subnets": [
          { "Ref": "Convox{{ upper .Process.App }}BaseSubnet0" },
          { "Ref": "Convox{{ upper .Process.App }}BaseSubnet1" },
          { "Ref": "Convox{{ upper .Process.App }}BaseSubnet2" },
          { "Ref": "Convox{{ upper .Process.App }}BaseSubnet3" }
        ],
        "ConnectionDrainingPolicy": { "Enabled": true, "Timeout": 60 },
        "ConnectionSettings": { "IdleTimeout": 60 },
        "CrossZone": true,
        "HealthCheck": {
          "HealthyThreshold": "2",
          "Interval": 5,
          "Target": "HTTP:3000/",
          "Timeout": 3,
          "UnhealthyThreshold": "2"
        },
        "LBCookieStickinessPolicy": [{ "PolicyName": "affinity" }],
        "LoadBalancerName": "convox-{{ .Process.App }}-{{ .Process.Name }}",
        "Listeners": [
          { "Protocol": "HTTP", "LoadBalancerPort": "80", "InstanceProtocol": "HTTP", "InstancePort": "3000" }
        ],
        "SecurityGroups": [ { "Ref": "Convox{{ upper .Process.App }}{{ upper .Process.Name }}BalancerSecurityGroup" } ]
      }
    },
  {{ end }}
  "Convox{{ upper .Process.App }}{{ upper .Process.Name }}Kinesis": {
    "Type": "AWS::Kinesis::Stream",
    "Properties": {
      "ShardCount": 1
    }
  },
  "Convox{{ upper .Process.App }}{{ upper .Process.Name }}IamRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
      "AssumeRolePolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": [ "ec2.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          }
        ]
      },
      "Path": "/",
      "Policies": [
        {
          "PolicyName": "{{ upper .Process.Name }}Role",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [ "logs:*" ],
                "Resource": [ "arn:aws:logs:*:*:*" ]
              },
              {
                "Effect": "Allow",
                "Action": [ "kinesis:PutRecords" ],
                "Resource": [ "arn:aws:kinesis:*:*:stream/convox-{{ .Process.App }}-*" ]
              },
              {
                "Effect": "Allow",
                "Action": [ "cloudwatch:PutMetricData" ],
                "Resource": [ "*" ]
              }
            ]
          }
        }
      ]
    }
  },
  "Convox{{ upper .Process.App }}{{ upper .Process.Name }}InstanceProfile": {
    "Type": "AWS::IAM::InstanceProfile",
    "Properties": {
      "Path": "/",
      "Roles": [ { "Ref": "Convox{{ upper .Process.App }}{{ upper .Process.Name }}IamRole" } ]
    }
  },
  "Convox{{ upper .Process.App }}{{ upper .Process.Name }}LaunchConfiguration": {
    "Type": "AWS::AutoScaling::LaunchConfiguration",
    "Properties": {
      "AssociatePublicIpAddress": true,
      "BlockDeviceMappings": [ 
        { "DeviceName": "/dev/sda1", "Ebs": { "VolumeSize": "10", "VolumeType": "standard" } }
      ],
      "EbsOptimized": false,
      "IamInstanceProfile": { "Ref": "Convox{{ upper .Process.App }}{{ upper .Process.Name }}InstanceProfile" },
      "ImageId": { "Fn::FindInMap": [ "Variables", "Ami", "Value" ] },
      "InstanceMonitoring": true,
      "InstanceType": "t2.micro",
      "KeyName": "production",
      "SecurityGroups": [ { "Ref": "Convox{{ upper .Process.App }}BaseSecurityGroup" } ],
      "UserData": {{ template "userdata" . }}
    }
  },
  "Convox{{ upper .Process.App }}{{ upper .Process.Name }}Instances": {
    "Type": "AWS::AutoScaling::AutoScalingGroup",
    "Properties" : {
      "LaunchConfigurationName" : { "Ref": "Convox{{ upper .Process.App }}{{ upper .Process.Name }}LaunchConfiguration" },
      "AvailabilityZones": [ {{ array .Process.AvailabilityZones }} ],
      "VPCZoneIdentifier": [ 
        { "Ref": "Convox{{ upper .Process.App }}BaseSubnet0" },
        { "Ref": "Convox{{ upper .Process.App }}BaseSubnet1" },
        { "Ref": "Convox{{ upper .Process.App }}BaseSubnet2" },
        { "Ref": "Convox{{ upper .Process.App }}BaseSubnet3" }
      ],
      "Cooldown": 5,
      "DesiredCapacity": "{{ .Process.Count }}",
      "MinSize" : "1",
      "MaxSize" : "3",
      {{ if .Process.Balancer }}
        "LoadBalancerNames": [ { "Ref": "Convox{{ upper .Process.App }}{{ upper .Process.Name }}Balancer" } ],
      {{ end }}
      "HealthCheckType": "EC2",
      "HealthCheckGracePeriod": 30,
      "MetricsCollection": [ { "Granularity": "1Minute" } ],
      "Tags": [
        { "Key": "Name", "Value": "{{ .Process.App }}-{{ .Process.Name }}", "PropagateAtLaunch": true }
      ]
    },
    "UpdatePolicy": {
      "AutoScalingRollingUpdate": {
        "MaxBatchSize": 1,
        "MinInstancesInService": 1
      }
    }
  },
{{ end }}

{{ define "userdata" }}
  {
    "Fn::Base64": {
      "Fn::Join": [ "\n", [
        "{",
        "  \"app\": \"{{ .Process.App }}\",",
        "  \"process\": \"{{ .Process.Name }}\",",
        "  \"logs\": {",
        { "Fn::Join": [ "", [ "    \"cwgroup\": \"", { "Ref": "Convox{{ upper .Process.App }}BaseLogGroup" }, "\"," ] ] },
        "    \"cwstream\": \"{{ .Process.Name }}\",",
        { "Fn::Join": [ "", [ "    \"kinesis\": \"", { "Ref": "Convox{{ upper .Process.App }}{{ upper .Process.Name }}Kinesis" }, "\"" ] ] },
        "  },",
        "  \"env\": [",
        { 
          "Fn::Join": [ "", [
            "    \"",
            {
              "Fn::Join": [ "\",\n    \"", [
                {{ safe .Env }}
                "CONVOX_APP={{ .Process.App }}"
              ] ]
            },
            "\""
          ] ]
        },
        "  ],",
        "  \"ports\": [ {{ ports .Process.Ports }} ]",
        "}"
      ] ]
    }
  }
{{ end }}
