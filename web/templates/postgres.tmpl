{{ define "env" }}
	{ "Fn::Join": [ "=", [ "POSTGRES_PORT_5432_TCP_ADDR", { "Fn::GetAtt": [ "{{ .FormationName }}", "Endpoint.Address" ] } ] ] },
	{ "Fn::Join": [ "=", [ "POSTGRES_PORT_5432_TCP_PORT", { "Fn::GetAtt": [ "{{ .FormationName }}", "Endpoint.Port"		] } ] ] },
	"POSTGRES_ENV_POSTGRES_USER=app",
	"POSTGRES_ENV_POSTGRES_PASSWORD=password",
	"POSTGRES_ENV_POSTGRES_DATABASE=app",
{{ end }}

{{ define "formation" }}
	"{{ .FormationName }}Security": {
		"Type": "AWS::EC2::SecurityGroup",
		"Properties": {
			"GroupDescription": "{{ .FormationName }}",
			"SecurityGroupIngress": [
				{ "IpProtocol": "tcp", "FromPort": "5432", "ToPort": "5432", "CidrIp": "10.0.0.0/16" }
			],
			"VpcId": { "Ref": "Vpc" }
		}
	},
	"{{ .FormationName }}SubnetGroup": {
		"Type": "AWS::RDS::DBSubnetGroup",
		"Properties": {
			"DBSubnetGroupDescription": "{{ .FormationName }}",
			"SubnetIds": [
				{ "Ref": "Subnet0" },
				{ "Ref": "Subnet1" },
				{ "Ref": "Subnet2" },
				{ "Ref": "Subnet3" }
			]
		}
	},
	"{{ .FormationName }}": {
		"Type": "AWS::RDS::DBInstance",
		"Properties": {
			"AllocatedStorage": "10",
			"DBInstanceClass": "db.t2.micro",
			"DBInstanceIdentifier": "convox-{{ .App }}-{{ .Name }}",
			"DBName": "app",
			"DBSubnetGroupName": { "Ref": "{{ .FormationName }}SubnetGroup" },
			"Engine": "postgres",
			"MasterUsername": "app",
			"MasterUserPassword": "password",
			"Port": "5432",
			"StorageType": "gp2",
			"VPCSecurityGroups": [ { "Ref": "{{ .FormationName }}Security" } ]
		}
	},
{{ end }}
