{{ define "service" }}
  {
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Conditions": {
      "Queue": { "Fn::Not": [ { "Fn::Equals": [ { "Ref": "Queue" }, "" ] } ] }
    },
    "Parameters": {
      "BucketName": {
        "Type" : "String",
        "Default": "",
        "Description" : "Bucket name"
      },
      "Queue": {
        "Type" : "String",
        "Default": "",
        "Description" : "SQS Queue Name"
      }
    },
    "Resources": {
        "Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "AccessControl": "Private",
                "NotificationConfiguration": {
                  "Fn::If": [ "Queue",
                    {
                      "QueueConfigurations": [
                        {
                          "Event" : "s3:ObjectCreated:*",
                          "Queue" : { "Fn::Join": [ ":", [ "arn:aws:sqs", { "Ref": "AWS::Region" }, { "Ref": "AWS::AccountId" }, { "Ref": "Queue" } ] ] }
                        },
                        {
                          "Event" : "s3:ObjectRemoved:*",
                          "Queue" : { "Fn::Join": [ ":", [ "arn:aws:sqs", { "Ref": "AWS::Region" }, { "Ref": "AWS::AccountId" }, { "Ref": "Queue" } ] ] }
                        }
                      ]
                    },
                    { "Ref" : "AWS::NoValue" }
                  ]
                },
                "Tags": [
                    { "Key": "system", "Value": "convox" },
                    { "Key": "service", "Value": { "Ref": "AWS::StackName" } }
                ]
            }
        },
        "QueuePolicy": {
          "Condition": "Queue",
          "Type": "AWS::SQS::QueuePolicy",
          "Properties" : {
            "PolicyDocument" : {
            "Version": "2008-10-17",
            "Id": "example-ID",
            "Statement": [{
              "Sid": "example-statement-ID",
              "Effect": "Allow",
              "Principal": {
                "AWS": "*"
              },
              "Action": [
                "SQS:*"
              ],
              "Resource": { "Fn::Join": [ ":", [ "arn:aws:sqs", { "Ref": "AWS::Region" }, { "Ref": "AWS::AccountId" }, { "Ref": "Queue" } ] ] },
              "Condition": {
                "ArnLike": {
                  "aws:SourceArn": { "Fn::Join": [ ":", [ "arn:aws:s3:*:*", { "Ref": "Bucket" } ] ] }
                }
              }
            }]
          },
          "Queues": [
            { "Fn::Join": [ "/", [
              { "Fn::Join": [ ".", [
                "https://sqs",
                { "Ref": "AWS::Region" },
                "amazonaws.com"
              ] ] },
              { "Ref": "AWS::AccountId" },
              { "Ref": "Queue" }
            ] ] }
          ]
        }
      }
    },
    "Outputs": {
      "Name": {
        "Value": { "Ref": "Bucket" }
      }
    }
  }
{{ end }}
