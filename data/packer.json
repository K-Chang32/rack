{
  "description": "Convox App",
  "variables": {
    "NAME": null,
    "SOURCE": null,
    "BASE_AMI": "ami-d881c2b0",
    "AWS_REGION": "us-east-1",
    "AWS_ACCESS": "{{env \"AWS_ACCESS\"}}",
    "AWS_SECRET": "{{env \"AWS_SECRET\"}}"
  },
  "builders": [
    {
      "type": "amazon-ebs",
      "region": "{{user \"AWS_REGION\"}}",
      "access_key": "{{user \"AWS_ACCESS\"}}",
      "secret_key": "{{user \"AWS_SECRET\"}}",
      "source_ami": "{{user \"BASE_AMI\"}}",
      "instance_type": "t2.micro",
      "ssh_username": "ubuntu",
      "ami_name": "{{user \"NAME\"}}-{{timestamp}}"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "inline": [
        "set -e",
        "mkdir /build",
        "chown ubuntu:ubuntu /build",
        "mkdir /var/app"
      ]
    },
    {
      "type": "file",
      "source": "{{user \"SOURCE\"}}/",
      "destination": "/build"
    },
    {
      "type": "shell",
      "inline": [
        "set -e",
        "cd /build",
        "/usr/local/bin/fig -p app build",
        "/usr/local/bin/fig -p app pull"
      ]
    },
    {
      "type": "file",
      "source": "app.conf",
      "destination": "/tmp/app.conf"
    },
    {
      "type": "file",
      "source": "cloudwatch-logs.conf",
      "destination": "/tmp/awslogs.conf"
    },
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "inline": [
        "mv /tmp/awslogs.conf /var/awslogs/etc/awslogs.conf"
      ]
    },
    {
      "type": "shell",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
      "inline": [
        "set -e",
        "rm -rf /build",
        "mv /tmp/app.conf /etc/init/app.conf"
      ]
    }
  ]
}
